title: volatile的原理
author: xdkxlk
tags:
  - 并发
categories:
  - Java
date: 2019-02-20 16:32:00
---
# 背景
## 数据不一致的问题
为了提高处理速度，CPU不直接和内存进行通信，而是先将系统内存的数据读到内部缓存后再进行操作，但什么时候写回主存的时间不定

![upload successful](/img/Oye33jbpjsN655vUNyGG.png)

- Main Memory——系统内存
- Bus——总线
- Cache——处理器缓存
- CPU Core——处理器核

所以，在没有锁的情况下，多个 CPU所看见的同一个变量的值可能是不一样的
## 指令重排
一般来说，处理器为了提高程序运行效率，可能会对输入代码进行优化，它不保证程序中各个语句的执行先后顺序同代码中的顺序一致，但是它会保证程序最终执行结果和代码顺序执行的结果是一致的。在单线程的情况下没有什么问题，但是如果在多线程的情况下，进行重排序可能会改变程序的执行结果。

对于代码
```java
double pi  = 3.14;    //A  
double r   = 1.0;     //B  
double area = pi * r * r; //C  
```
C依赖 A、B，但是 A、B之间没有依赖关系，所以，B有可能会在 A前面执行，但是 C不能被重排序到A和B的前面

# volatile的特性
## 可见性
对一个 volatile变量的读，总是能看到（任意线程）对这个 volatile变量最后的写入。
## 有序性
- 当程序执行到 volatile变量的读或写时，在其前面的操作肯定全部已经进行，且结果已经对后面的操作可见；在其后面的操作肯定还没有进行
- 在进行指令优化时，不能将在对volatile变量访问的语句放在其后面执行，也不能把volatile变量后面的语句放到其前面执行

例如
```java
//x、y为非volatile变量
//flag为volatile变量
 
x = 2;         //语句1
y = 0;         //语句2
flag = true;   //语句3
x = 4;         //语句4
y = -1;        //语句5
```
由于 flag变量为 volatile变量，那么在进行指令重排序的过程的时候，不会将语句 3放到语句1、语句2前面，也不会讲语句3放到语句4、语句5后面。但是要注意语句1和语句2的顺序、语句4和语句5的顺序是不作任何保证的。  
并且 volatile关键字能保证，执行到语句3时，语句1和语句2必定是执行完毕了的，且语句1和语句2的执行结果对语句3、语句4、语句5是可见的。
## 不具有原子性
对任意单个 volatile变量的读/写具有原子性，但类似于 `volatile++`, `int b=a` 这种复合操作不具有原子性。

# volatile的实现原理
有volatile变量修饰的共享变量进行写操作的时候，会多出一行以Lock为前缀的汇编代码以保证可见性和有序性

volatile实现的两条原则：
- Lock前缀指令会引起处理器缓存回写到内存  
**lock前缀指令相当于一个内存屏障**（也称内存栅栏），内存屏障主要提供3个功能：
	- **保证有序性**。确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；
	- **强制将对缓存的修改操作立即写入主存**，利用缓存一致性机制，并且缓存一致性机制会阻止同时修改由两个以上CPU缓存的内存区域数据；
	- **如果是写操作，它会导致其他CPU中对应的缓存行无效。**
- 一个处理器的缓存回写到内存会导致其他处理器的缓存失效（解决缓存一致性问题）  
处理器使用**嗅探技术**保证它的内部缓存、系统内存和其他处理器的缓存的数据在总线上保持一致。例如CPU A嗅探到CPU B打算写内存地址，且这个地址处于共享状态，**那么正在嗅探的处理器将使它的缓存行无效，在下次访问相同内存地址时，强制执行缓存行填充**。

![upload successful](/img/3w85LoYZv6yX3tnI0nLM.png)

# 参考
[Volatile的实现原理](https://www.cnblogs.com/yaoyunxiaoli/p/6605295.html)  
[volatile实现原理（内存屏障、缓存一致协议--Lock前缀指令--写缓存、高速缓存、主存）](https://www.jianshu.com/p/9abb4a23ab05)  
[并发关键字volatile（重排序和内存屏障）](https://www.jianshu.com/p/ef8de88b1343)